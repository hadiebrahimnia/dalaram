<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }}</title>
    {% load static %}
    <link href="{% static 'plugins/bootstrap/css/bootstrap.rtl.min.css' %}" rel="stylesheet" />
    <link href="{% static 'css/pcm.css' %}" rel="stylesheet" />
</head>
<body>
    <!-- پیام چرخش دستگاه -->
    <div id="rotate-device">
        <i>↻</i>
        <h3>لطفاً گوشی خود را بچرخانید</h3>
        <p>برای تجربه بهتر، صفحه را به حالت افقی (landscape) درآورید.</p>
    </div>

    <div class="content">
        <!-- Fixation Cross -->
        <div id="fixation" class="full-center hidden">
            <div class="fixation">+</div>
        </div>

        <audio id="audio-player" preload="auto"></audio>

        <!-- ۱. مقدمه مرحله تمرینی تشخیص توالی -->
        <div id="seq-practice-intro" class="p-5 m-auto text-center hidden">
            <div class="card">
                <div class="card-body">
                    <h3 class="mb-4">خوش آمدید به آزمایش حافظه کاری عاطفی (PCM)</h3>
                    <p class="lead">
                        در این آزمایش، ابتدا یک نشانه صوتی (Cue) می‌شنوید و سپس دو صدای عاطفی متوالی.<br>
                        ابتدا باید یاد بگیرید که توالی این صداها را تشخیص دهید.
                    </p>
                    <button class="btn btn-success btn-lg mt-4" id="start-seq-practice">
                        شروع مرحله تمرینی تشخیص توالی
                    </button>
                </div>
            </div>
        </div>

        <!-- ادامه مرحله تمرینی تشخیص توالی -->
        <div id="resume-seq-practice" class="py-5 text-center hidden">
            <div class="card">
                <div class="card-body">
                    <h3>ادامه مرحله تمرینی تشخیص توالی</h3>
                    <p class="lead" id="resume-seq-message"></p>
                    <button class="btn btn-warning btn-lg mt-4" id="resume-seq-btn">
                        ادامه تمرین
                    </button>
                </div>
            </div>
        </div>

        <!-- انتخاب توالی در مرحله تمرینی -->
        <div id="seq-practice-choice" class="hidden py-5">
            <div class="card">
                <div class="card-body text-center">
                    <h3>کدام توالی شنیده شد؟</h3>
                    <div class="d-flex flex-column gap-3 mt-4">
                        <button class="btn btn-outline-primary sequence-btn" data-seq="Neutral-Neutral">
                            خنثی → خنثی
                        </button>
                        <button class="btn btn-outline-primary sequence-btn" data-seq="Negative-Neutral">
                            منفی → خنثی
                        </button>
                        <button class="btn btn-outline-primary sequence-btn" data-seq="Neutral-Negative">
                            خنثی → منفی
                        </button>
                    </div>
                    <div id="seq-feedback" class="mt-4 fs-4 fw-bold"></div>
                </div>
            </div>
        </div>

        <!-- ۲. مقدمه تمرین رتبه‌بندی خوشایندی -->
        <div id="valence-practice-intro" class="hidden py-5 text-center">
            <div class="card">
                <div class="card-body">
                    <h3>تمرین رتبه‌بندی خوشایندی</h3>
                    <p class="lead">
                        حالا باید یاد بگیرید که خوشایندی هر صدا و کل توالی را رتبه‌بندی کنید.<br>
                        در هر تریال، سه بار رتبه‌بندی خواهید کرد:
                    </p>
                    <ol class="lead text-start mx-auto" style="max-width: 600px">
                        <li>محرک اول</li>
                        <li>محرک دوم</li>
                        <li>کل توالی</li>
                    </ol>
                    <button class="btn btn-success btn-lg mt-4" id="start-valence-practice">
                        شروع تمرین رتبه‌بندی خوشایندی
                    </button>
                </div>
            </div>
        </div>

        <!-- ادامه تمرین رتبه‌بندی خوشایندی -->
        <div id="resume-valence-practice" class="py-5 text-center hidden">
            <div class="card">
                <div class="card-body">
                    <h3>ادامه تمرین رتبه‌بندی خوشایندی</h3>
                    <p class="lead" id="resume-valence-message"></p>
                    <button class="btn btn-warning btn-lg mt-4" id="resume-valence-btn">
                        ادامه تمرین
                    </button>
                </div>
            </div>
        </div>

        <!-- ۳. مقدمه آزمون اصلی -->
        <div id="main-intro" class="hidden py-5 text-center">
            <div class="card">
                <div class="card-body">
                    <h3>تبریک! تمرین‌ها با موفقیت به پایان رسید.</h3>
                    <p class="lead">
                        اکنون آزمون اصلی آغاز می‌شود (۴ بلوک، هر بلوک ۸ تریال).<br>
                        در ابتدای هر بلوک، یک Catch Trial برای تشخیص توالی خواهید داشت.
                    </p>
                    <button class="btn btn-primary btn-lg mt-4" id="start-main">
                        شروع آزمون اصلی
                    </button>
                </div>
            </div>
        </div>

        <!-- ادامه آزمون اصلی -->
        <div id="resume-main" class="py-5 text-center hidden">
            <div class="card">
                <div class="card-body">
                    <h3>خوش آمدید دوباره!</h3>
                    <p class="lead" id="resume-main-message"></p>
                    <button class="btn btn-warning btn-lg mt-4" id="resume-main-btn">
                        ادامه آزمون اصلی
                    </button>
                </div>
            </div>
        </div>

        <!-- استراحت بین بلوک‌ها -->
        <div id="block-break" class="py-5 text-center hidden">
            <div class="card">
                <div class="card-body">
                    <h3>استراحت کوتاه</h3>
                    <p class="lead" id="block-break-message"></p>
                    <button class="btn btn-primary btn-lg mt-4" id="continue-after-break">
                        شروع بلوک بعدی
                    </button>
                </div>
            </div>
        </div>

        <!-- رتبه‌بندی خوشایندی (مشترک برای مراحل ۲ و ۳) -->
        <div id="valence-rating" class="py-5 hidden">
            <div class="card">
                <div class="card-body text-center sam-container">
                    <h3 id="valence-question" class="mb-4"></h3>
                    <div class="sam-buttons">
                        {% for i in "123456789" %}
                        <button type="button" class="sam-btn" data-value="{{ forloop.counter }}">
                            <img src="{% static 'images/valence/' %}{{ forloop.counter }}.png" alt="Valence {{ forloop.counter }}" />
                            <div class="key-hint">{{ forloop.counter }}</div>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ۴. مقدمه تمرین رتبه‌بندی Valence + Arousal -->
        <div id="rating-practice-intro" class="py-5 text-center hidden">
            <div class="card">
                <div class="card-body">
                    <h3>تمرین رتبه‌بندی کامل (خوشایندی و برانگیختگی)</h3>
                    <p class="lead">
                        حالا چند صدا خواهید شنید و باید هر دو بعد را رتبه‌بندی کنید:<br>
                        ۱. خوشایندی (Valence)<br>
                        ۲. برانگیختگی (Arousal)
                    </p>
                    <button class="btn btn-info btn-lg mt-4" id="start-rating-practice">
                        شروع تمرین رتبه‌بندی کامل
                    </button>
                </div>
            </div>
        </div>

        <!-- ادامه تمرین رتبه‌بندی کامل -->
        <div id="resume-rating-practice" class="py-5 text-center hidden">
            <div class="card">
                <div class="card-body">
                    <h3>ادامه تمرین رتبه‌بندی کامل</h3>
                    <p class="lead" id="resume-rating-practice-message"></p>
                    <button class="btn btn-info btn-lg mt-4" id="resume-rating-practice-btn">
                        ادامه تمرین
                    </button>
                </div>
            </div>
        </div>

        <!-- رتبه‌بندی برانگیختگی -->
        <div id="arousal-rating" class="py-5 hidden">
            <div class="card">
                <div class="card-body text-center sam-container">
                    <h3>لطفاً میزان برانگیختگی صدا را انتخاب کنید</h3>
                    <div class="sam-buttons">
                        {% for i in "123456789" %}
                        <button type="button" class="sam-btn" data-value="{{ forloop.counter }}">
                            <img src="{% static 'images/arousal/' %}{{ forloop.counter }}.jpg" alt="Arousal {{ forloop.counter }}" />
                            <div class="key-hint">{{ forloop.counter }}</div>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ۵. مقدمه رتبه‌بندی اصلی -->
        <div id="rating-main-intro" class="py-5 text-center hidden">
            <div class="card">
                <div class="card-body">
                    <h3>رتبه‌بندی نهایی صداها</h3>
                    <p class="lead">
                        تمام صداهایی که در آزمون اصلی شنیدید، حالا به صورت تک‌تک پخش می‌شوند.<br>
                        برای هر صدا، خوشایندی و برانگیختگی را رتبه‌بندی کنید.
                    </p>
                    <button class="btn btn-info btn-lg mt-4" id="start-rating-main">
                        شروع رتبه‌بندی نهایی
                    </button>
                </div>
            </div>
        </div>

        <!-- ادامه رتبه‌بندی اصلی -->
        <div id="resume-rating-main" class="py-5 text-center hidden">
            <div class="card">
                <div class="card-body">
                    <h3>ادامه رتبه‌بندی نهایی</h3>
                    <p class="lead" id="resume-rating-main-message"></p>
                    <button class="btn btn-info btn-lg mt-4" id="resume-rating-main-btn">
                        ادامه رتبه‌بندی
                    </button>
                </div>
            </div>
        </div>

        <!-- صفحه پایان -->
        <div id="final-thanks" class="py-5 text-center hidden">
            <div class="card m-auto">
                <div class="card-body text-center">
                    <h2 class="display-5">متشکریم!</h2>
                    <p class="lead">تمام مراحل آزمایش با موفقیت به پایان رسید.</p>
                    <p class="text-muted">می‌توانید این تب را ببندید.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const cueUrls = {{ cue_urls|safe }};
        const neutralUrls = {{ neutral_urls|safe }};
        const negativeUrls = {{ negative_urls|safe }};
        const cuesMapping = {{ cues_mapping|safe }};

        const NUM_BLOCKS = {{ NUM_BLOCKS }};
        const TRIALS_PER_BLOCK = {{ TRIALS_PER_BLOCK }};
        const CATCH_TRIALS_PER_BLOCK = {{ CATCH_TRIALS_PER_BLOCK }};
        const SEQ_PRACTICE_TRIALS = {{ SEQ_PRACTICE_TRIALS }};
        const SEQ_THRESHOLD = {{ SEQ_THRESHOLD }};
        const VALENCE_PRACTICE_TRIALS = {{ VALENCE_PRACTICE_TRIALS }};
        const RATING_PRACTICE_TRIALS = {{ RATING_PRACTICE_TRIALS }};
        const INCONSISTENT_RATIO = {{ INCONSISTENT_RATIO }};

        const reratingFiles = {{ rerating_files|safe }};
        const TOTAL_RERATING_FILES = {{ TOTAL_RERATING_FILES }};
        const RERATING_COMPLETED_COUNT = {{ RERATING_COMPLETED_COUNT }};

        const CURRENT_BLOCK_INIT = {{ CURRENT_BLOCK_INIT }};
        const CURRENT_TRIAL_INIT = {{ CURRENT_TRIAL_INIT }};
        const SEQ_CORRECT_INIT = {{ SEQ_CORRECT_INIT }};
        const SEQ_TOTAL_INIT = {{ SEQ_TOTAL_INIT }};
        const VALENCE_PRACTICE_COMPLETED_COUNT = {{ VALENCE_PRACTICE_COMPLETED_COUNT }};
        const RATING_PRACTICE_COMPLETED_COUNT = {{ RATING_PRACTICE_COMPLETED_COUNT }};

        const INITIAL_STAGE = "{{ INITIAL_STAGE }}";
        const SHOW_RESUME_SCREEN = {{ SHOW_RESUME_SCREEN }} === 'true';
        const RESUME_MESSAGE = "{{ RESUME_MESSAGE|escapejs }}";
        const IS_AT_BLOCK_BREAK = {{ IS_AT_BLOCK_BREAK }} === 'true';
        const BLOCK_BREAK_MESSAGE = "{{ BLOCK_BREAK_MESSAGE|escapejs }}";
    </script>

    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'js/pcm.js' %}"></script>
</body>
</html>