<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مرحله ۳: آزمون اصلی PCM</title>
    {% load static %}
    <link href="{% static 'plugins/bootstrap/css/bootstrap.rtl.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/pcm.css' %}" rel="stylesheet">
</head>
<body>

    <div id="rotate-device">
        <i>↻</i>
        <h3>لطفاً گوشی خود را بچرخانید</h3>
        <p>برای تجربه بهتر، صفحه را به حالت افقی درآورید.</p>
    </div>

    <div class="content">

        <!-- مقدمه -->
        <div id="intro" class="card p-5 text-center" style="max-width: 700px;">
            <h2 class="mb-4">مرحله ۳: آزمون اصلی حافظه کاری عاطفی (PCM)</h2>
            <p class="lead mb-4">
                اکنون آزمون اصلی آغاز می‌شود. شامل ۴ بلوک است، هر بلوک ۸ تریال دارد.<br>
                در ابتدای هر بلوک، یک Catch Trial خواهید داشت (تشخیص توالی).<br>
                در بقیه تریال‌ها، سه بار خوشایندی را رتبه‌بندی می‌کنید.
            </p>
            <p class="text-muted">لطفاً با تمرکز کامل ادامه دهید.</p>
            <button id="start-btn" class="btn btn-primary btn-lg mt-4 px-5">شروع آزمون اصلی</button>
        </div>

        <!-- آزمون اصلی -->
        <div id="trial" class="hidden full-center sam-container">
            <div class="text-center">
                <p class="lead mb-4">بلوک {{ current_block }} — تریال {{ current_trial }} از {{ trials_per_block }}</p>

                <div id="fixation" class="fixation hidden">+</div>

                <!-- Catch Trial -->
                <div id="catch-choice" class="my-5 hidden">
                    <h4 class="mb-4">کدام توالی شنیده شد؟</h4>
                    <div class="d-grid gap-3 my-4" style="max-width: 500px; margin: auto;">
                        <button class="btn btn-outline-primary btn-lg" data-seq="Neutral-Neutral">خنثی → خنثی</button>
                        <button class="btn btn-outline-primary btn-lg" data-seq="Negative-Neutral">منفی → خنثی</button>
                        <button class="btn btn-outline-primary btn-lg" data-seq="Neutral-Negative">خنثی → منفی</button>
                    </div>
                    <div id="catch-feedback" class="mt-4 fs-3 fw-bold"></div>
                </div>

                <!-- رتبه‌بندی Valence -->
                <div id="valence-rating" class="hidden">
                    <h3 id="valence-question" class="my-5 fs-3"></h3>
                    <div class="sam-buttons">
                        {% for i in "123456789" %}
                        <button type="button" class="sam-btn" data-value="{{ forloop.counter }}">
                            <img src="{% static 'images/valence/' %}{{ forloop.counter }}.png">
                            <div class="key-hint">{{ forloop.counter }}</div>
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <audio id="audio-player" preload="auto"></audio>
            </div>
        </div>

    </div>

    <script>
        const cueUrls = {{ cue_urls|safe }};
        const neutralUrls = {{ neutral_urls|safe }};
        const negativeUrls = {{ negative_urls|safe }};
        const cuesMapping = {{ cues_mapping|safe }};
        const INCONSISTENT_RATIO = 0.20;

        const audio = document.getElementById('audio-player');
        const fixation = document.getElementById('fixation');
        const catchChoice = document.getElementById('catch-choice');
        const catchFeedback = document.getElementById('catch-feedback');
        const valenceRating = document.getElementById('valence-rating');
        const valenceQuestion = document.getElementById('valence-question');
        const intro = document.getElementById('intro');
        const trial = document.getElementById('trial');

        const questions = [
            "لطفاً خوشایندی محرک اول را رتبه‌بندی کنید",
            "لطفاً خوشایندی محرک دوم را رتبه‌بندی کنید",
            "لطفاً خوشایندی کل توالی را رتبه‌بندی کنید"
        ];

        let step = 0;
        let startTime;
        let currentCue, currentStim1, currentStim2, expectedSeq, actualSeq;
        let v1, rt1, v2, rt2, vSeq, rtSeq;

        function getCsrfToken() {
            const name = 'csrftoken';
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [key, value] = cookie.trim().split('=');
                if (key === name) return decodeURIComponent(value);
            }
            return '';
        }

        function showFixation(cb) {
            fixation.classList.remove('hidden');
            setTimeout(() => {
                fixation.classList.add('hidden');
                cb();
            }, 1000);
        }

        function play(url, next) {
            audio.src = url;
            audio.play().catch(e => console.error(e));
            audio.onended = () => setTimeout(next, 500);
        }

        function startTrial() {
            currentCue = cueUrls[Math.floor(Math.random() * cueUrls.length)];
            expectedSeq = cuesMapping[currentCue];

            const isInconsistent = Math.random() < INCONSISTENT_RATIO;
            actualSeq = isInconsistent ? Object.values(cuesMapping).filter(s => s !== expectedSeq)[Math.floor(Math.random() * 2)] : expectedSeq;

            const [cat1, cat2] = actualSeq.split('-');
            const pool1 = cat1 === 'Neutral' ? neutralUrls : negativeUrls;
            const pool2 = cat2 === 'Neutral' ? neutralUrls : negativeUrls;
            currentStim1 = pool1[Math.floor(Math.random() * pool1.length)];
            currentStim2 = pool2[Math.floor(Math.random() * pool2.length)];

            const isCatch = {{ current_trial }} <= 2;  // ابتدای هر بلوک

            showFixation(() => {
                play(currentCue, () => {
                    play(currentStim1, () => {
                        play(currentStim2, () => {
                            if (isCatch) {
                                catchChoice.classList.remove('hidden');
                            } else {
                                step = 0;
                                v1 = v2 = vSeq = null;
                                valenceQuestion.textContent = questions[0];
                                valenceRating.classList.remove('hidden');
                                startTime = Date.now();
                            }
                        });
                    });
                });
            });
        }

        // Catch Trial
        document.querySelectorAll('#catch-choice [data-seq]').forEach(btn => {
            btn.onclick = () => {
                const correct = btn.dataset.seq === expectedSeq;
                catchFeedback.textContent = correct ? 'درست!' : 'غلط!';
                catchFeedback.style.color = correct ? 'green' : 'red';

                fetch('/pcm/save/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken()},
                    body: JSON.stringify({
                        block: {{ current_block }},
                        trial: {{ current_trial }},
                        cue: currentCue,
                        expected_sequence: expectedSeq,
                        is_catch: true
                    })
                }).then(() => {
                    setTimeout(() => location.href = '/pcm/', 2000);
                });
            };
        });

        // Valence Rating
        document.querySelectorAll('.sam-btn').forEach(btn => {
            btn.onclick = () => {
                const value = parseInt(btn.dataset.value);
                const rt = Date.now() - startTime;

                if (step === 0) v1 = value, rt1 = rt;
                else if (step === 1) v2 = value, rt2 = rt;
                else vSeq = value, rtSeq = rt;

                btn.classList.add('selected');

                if (step < 2) {
                    step++;
                    setTimeout(() => {
                        valenceQuestion.textContent = questions[step];
                        startTime = Date.now();
                        document.querySelectorAll('.sam-btn').forEach(b => b.classList.remove('selected'));
                    }, 600);
                } else {
                    fetch('/pcm/save/', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken()},
                        body: JSON.stringify({
                            block: {{ current_block }},
                            trial: {{ current_trial }},
                            cue: currentCue,
                            stimulus1: currentStim1,
                            stimulus2: currentStim2,
                            expected_sequence: expectedSeq,
                            is_consistent: actualSeq === expectedSeq,
                            valence_stim1: v1, valence_rt_stim1: rt1,
                            valence_stim2: v2, valence_rt_stim2: rt2,
                            valence_sequence: vSeq, valence_rt_sequence: rtSeq
                        })
                    }).then(() => {
                        setTimeout(() => location.href = '/pcm/', 1000);
                    });
                }
            };
        });

        document.getElementById('start-btn').onclick = () => {
            intro.classList.add('hidden');
            trial.classList.remove('hidden');
            startTrial();
        };

        document.addEventListener('keydown', e => {
            if (e.key >= '1' && e.key <= '9') {
                document.querySelector(`.sam-btn[data-value="${e.key}"]`)?.click();
            }
        });
    </script>
</body>
</html>